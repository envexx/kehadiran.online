// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TENANT (Multi-tenant Support / School)
// ============================================
model Tenant {
  id              String   @id @default(cuid())
  nama_sekolah    String   @db.VarChar(100)
  slug            String   @unique @db.VarChar(50) // untuk subdomain: slug.kehadiran.com
  custom_domain   String?  @unique @db.VarChar(255) // custom domain (one-time Rp 3jt)
  alamat          String?  @db.Text
  nomor_telepon   String?  @db.VarChar(20)
  email           String?  @db.VarChar(100)
  logo            String?  @db.VarChar(255)
  qr_mode         String   @default("flexible") @db.VarChar(20) // 'gate_only', 'class_only', 'flexible'
  is_active       Boolean  @default(true)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relations
  users         User[]
  kelas         Kelas[]
  siswa         Siswa[]
  jadwal        Jadwal[]
  presensi      Presensi[]
  notifikasi    Notifikasi[]
  settings      Setting[]
  gurus         Guru[]
  subscription  Subscription?
  invoices      Invoice[]
  audit_logs    AuditLog[]
  api_keys      ApiKey[]
  feature_quota FeatureQuota?
  invites       Invite[]

  @@index([is_active])
  @@map("tenants")
}

// ============================================
// USER (Admin & Guru yang bisa login)
// ============================================
model User {
  id            String    @id @default(cuid())
  tenant_id     String? // Null untuk superadmin (bisa akses semua tenant)
  username      String    @db.VarChar(50)
  email         String    @db.VarChar(100)
  password_hash String    @db.VarChar(255)
  role          String    @default("admin") @db.VarChar(20) // 'superadmin', 'admin', atau 'guru'
  nama_lengkap  String    @db.VarChar(100)
  nomor_telepon String?   @db.VarChar(20)
  foto          String?   @db.VarChar(255)
  is_active     Boolean   @default(true)
  last_login    DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  // Relations
  tenant         Tenant?    @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  guru           Guru?
  presensi_input Presensi[] @relation("PresensiInputBy")
  audit_logs     AuditLog[]
  invites_sent   Invite[]

  @@unique([username])
  @@unique([email])
  @@index([tenant_id, role, is_active]) // Dashboard: list users by tenant + role
  @@index([tenant_id, is_active])
  @@map("users")
}

// ============================================
// GURU (Data Guru - Disederhanakan)
// ============================================
model Guru {
  id            String   @id @default(cuid())
  tenant_id     String
  user_id       String?  @unique // Optional, jika guru punya akun login
  nip           String?  @db.VarChar(20)
  nama_guru     String   @db.VarChar(100)
  nomor_telepon String?  @db.VarChar(20)
  nomor_wa      String?  @db.VarChar(20)
  email         String?  @db.VarChar(100)
  foto          String?  @db.VarChar(255)
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@unique([tenant_id, nip])
  @@index([tenant_id, is_active]) // List active guru per tenant
  @@map("guru")
}

// ============================================
// KELAS
// ============================================
model Kelas {
  id            String   @id @default(cuid())
  tenant_id     String
  nama_kelas    String   @db.VarChar(20) // Contoh: 'XII RPL 1', 'XI RPL 2'
  tingkat       String   @db.VarChar(10) // 'X', 'XI', 'XII'
  jurusan       String?  @db.VarChar(50) // 'RPL', 'TKJ', 'MM', dll
  wali_kelas_id String? // ID dari Guru
  tahun_ajaran  String   @db.VarChar(20) // '2024/2025'
  semester      String   @db.VarChar(10) // 'ganjil' atau 'genap'
  qr_code       String?  @unique @db.VarChar(255) // QR code kelas (optional, jika qrMode = class_only)
  kapasitas     Int      @default(40)
  jumlah_siswa  Int      @default(0)
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Relations
  tenant Tenant  @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  siswa  Siswa[]

  @@unique([tenant_id, nama_kelas, tahun_ajaran, semester])
  @@index([tenant_id, tahun_ajaran, semester, is_active]) // List kelas per tenant per semester
  @@index([tenant_id, is_active])
  @@map("kelas")
}

// ============================================
// SISWA (Dengan Data Orang Tua Digabung)
// ============================================
model Siswa {
  id             String    @id @default(cuid())
  tenant_id      String
  nisn           String    @db.VarChar(20)
  nis            String?   @db.VarChar(20)
  nama_lengkap   String    @db.VarChar(100)
  nama_panggilan String?   @db.VarChar(50)
  jenis_kelamin  String    @db.VarChar(1) // 'L' atau 'P'
  tempat_lahir   String?   @db.VarChar(50)
  tanggal_lahir  DateTime?
  alamat         String?   @db.Text
  email          String?   @db.VarChar(100)
  nomor_telepon  String?   @db.VarChar(20)
  foto           String?   @db.VarChar(255)
  qr_code        String?   @unique @db.VarChar(255) // QR code unik per siswa
  kelas_id       String
  tahun_masuk    Int
  status         String    @default("aktif") @db.VarChar(20) // 'aktif', 'lulus', 'pindah', 'keluar'

  // Data Orang Tua (Digabung)
  nama_ayah             String? @db.VarChar(100)
  nomor_wa_ayah         String? @db.VarChar(20) // Format: 6281234567890
  nama_ibu              String? @db.VarChar(100)
  nomor_wa_ibu          String? @db.VarChar(20) // Format: 6281234567890
  preferensi_notifikasi String? @default("ayah") @db.VarChar(10) // 'ayah', 'ibu', 'keduanya'

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  tenant     Tenant       @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  kelas      Kelas        @relation(fields: [kelas_id], references: [id], onDelete: Restrict)
  presensi   Presensi[]
  notifikasi Notifikasi[]

  @@unique([tenant_id, nisn])
  @@unique([tenant_id, nis])
  @@index([tenant_id, kelas_id, status]) // List siswa per kelas (most common query)
  @@index([tenant_id, status]) // Count/filter siswa by status
  @@index([tenant_id, nama_lengkap]) // Search siswa by name
  @@index([kelas_id, status]) // Kelas detail page
  @@map("siswa")
}

// ============================================
// JADWAL (Jam Masuk & Pulang per Hari)
// ============================================
model Jadwal {
  id         String   @id @default(cuid())
  tenant_id  String
  hari       String   @db.VarChar(10) // 'senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu', 'minggu'
  jam_masuk  String   @db.VarChar(5) // Format: '07:00'
  jam_pulang String   @db.VarChar(5) // Format: '15:00'
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  tenant   Tenant     @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  presensi Presensi[]

  @@unique([tenant_id, hari])
  @@index([tenant_id, is_active]) // Get active schedule per tenant
  @@map("jadwal")
}

// ============================================
// PRESENSI
// ============================================
model Presensi {
  id            String    @id @default(cuid())
  tenant_id     String
  siswa_id      String
  jadwal_id     String // ID dari Jadwal (untuk tahu hari dan jam)
  tanggal       DateTime  @db.Date
  waktu_masuk   DateTime? // Waktu siswa melakukan presensi masuk
  waktu_pulang  DateTime? // Waktu siswa melakukan presensi pulang
  status_masuk  String    @db.VarChar(20) // 'hadir', 'terlambat', 'alpha'
  status_pulang String?   @db.VarChar(20) // 'pulang', 'tidak_pulang'
  metode_input  String    @default("manual") @db.VarChar(20) // 'qr_code', 'fingerprint', 'manual'
  keterangan    String?   @db.Text // Alasan izin/sakit jika ada
  foto_bukti    String?   @db.VarChar(255)
  input_by      String? // User ID yang input (jika manual)
  latitude      Decimal?  @db.Decimal(10, 8)
  longitude     Decimal?  @db.Decimal(11, 8)
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  // Relations
  tenant     Tenant       @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  siswa      Siswa        @relation(fields: [siswa_id], references: [id], onDelete: Cascade)
  jadwal     Jadwal       @relation(fields: [jadwal_id], references: [id], onDelete: Restrict)
  input_user User?        @relation("PresensiInputBy", fields: [input_by], references: [id], onDelete: SetNull)
  notifikasi Notifikasi[]

  @@unique([tenant_id, siswa_id, tanggal])
  @@index([tenant_id, tanggal, status_masuk]) // Dashboard: daily stats by status (HOT PATH)
  @@index([tenant_id, tanggal]) // Dashboard: all attendance for a date
  @@index([tenant_id, siswa_id, tanggal]) // Student attendance history
  @@index([siswa_id, tanggal]) // Student detail: attendance range
  @@index([tenant_id, created_at]) // Recent attendance feed (live activity)
  @@index([jadwal_id, tanggal]) // Schedule-based lookup
  @@map("presensi")
}

// ============================================
// NOTIFIKASI (Log WhatsApp)
// ============================================
model Notifikasi {
  id               String    @id @default(cuid())
  tenant_id        String
  siswa_id         String
  presensi_id      String?
  nomor_tujuan     String    @db.VarChar(20) // Nomor WA yang dikirimi
  jenis_notifikasi String    @db.VarChar(50) // 'presensi_hadir', 'presensi_alpha', 'presensi_terlambat', 'laporan_harian', 'laporan_mingguan'
  pesan            String    @db.Text
  status           String    @default("pending") @db.VarChar(20) // 'pending', 'sent', 'failed', 'delivered'
  response_data    Json? // Response dari API WhatsApp
  error_message    String?   @db.Text
  sent_at          DateTime?
  created_at       DateTime  @default(now())

  // Relations
  tenant   Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  siswa    Siswa     @relation(fields: [siswa_id], references: [id], onDelete: Cascade)
  presensi Presensi? @relation(fields: [presensi_id], references: [id], onDelete: SetNull)

  @@index([tenant_id, created_at]) // Notification log per tenant
  @@index([tenant_id, siswa_id]) // Notifications for a student
  @@index([status, created_at]) // Retry queue: pending notifications (HOT PATH)
  @@index([presensi_id]) // Lookup by presensi
  @@map("notifikasi")
}

// ============================================
// SETTINGS (Pengaturan Sistem per Tenant)
// ============================================
model Setting {
  id          String   @id @default(cuid())
  tenant_id   String
  key         String   @db.VarChar(100)
  value       String?  @db.Text
  description String?  @db.Text
  category    String?  @db.VarChar(50) // 'general', 'notifikasi', 'presensi', 'whatsapp'
  updated_at  DateTime @updatedAt
  updated_by  String? // User ID

  // Relations
  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, key])
  @@index([tenant_id, category]) // Settings by category per tenant
  @@map("settings")
}

// ============================================
// BILLING & SUBSCRIPTION
// ============================================
model Subscription {
  id            String    @id @default(cuid())
  tenant_id     String    @unique
  plan          String    @db.VarChar(50) // 'free', 'starter', 'pro', 'enterprise'
  status        String    @default("active") @db.VarChar(20) // 'active', 'canceled', 'past_due', 'expired'
  billing_cycle String    @db.VarChar(20) // 'monthly', 'annual'
  amount        Decimal   @db.Decimal(10, 2)
  currency      String    @default("IDR") @db.VarChar(10)
  started_at    DateTime
  ended_at      DateTime?
  canceled_at   DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@index([status, plan]) // Admin: filter subscriptions
  @@map("subscriptions")
}

model Invoice {
  id             String    @id @default(cuid())
  tenant_id      String
  invoice_number String    @unique @db.VarChar(50)
  amount         Decimal   @db.Decimal(10, 2)
  status         String    @db.VarChar(20) // 'draft', 'sent', 'paid', 'failed', 'cancelled'
  issued_at      DateTime
  due_at         DateTime
  paid_at        DateTime?
  payment_method String?   @db.VarChar(50)
  notes          String?   @db.Text
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@index([tenant_id, status]) // Invoices per tenant by status
  @@index([tenant_id, issued_at]) // Invoice history
  @@map("invoices")
}

// ============================================
// AUDIT & ACTIVITY LOG
// ============================================
model AuditLog {
  id          String   @id @default(cuid())
  tenant_id   String?
  user_id     String?
  action      String   @db.VarChar(50) // 'create', 'update', 'delete', 'login', 'logout'
  entity_type String   @db.VarChar(50) // 'siswa', 'presensi', 'user', 'kelas', dll
  entity_id   String?
  changes     Json? // Perubahan data (before/after)
  ip_address  String?  @db.VarChar(45) // IPv4 atau IPv6
  user_agent  String?  @db.Text
  created_at  DateTime @default(now())

  // Relations
  tenant Tenant? @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  user   User?   @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([tenant_id, created_at]) // Audit log timeline per tenant (HOT PATH)
  @@index([tenant_id, entity_type, created_at]) // Filter by entity type
  @@index([user_id, created_at]) // User activity log
  @@map("audit_logs")
}

// ============================================
// API KEYS & INTEGRATION
// ============================================
model ApiKey {
  id           String    @id @default(cuid())
  tenant_id    String
  key          String    @unique @db.VarChar(255) // Hashed API key
  name         String    @db.VarChar(100)
  description  String?   @db.Text
  permissions  Json? // Array of permissions
  is_active    Boolean   @default(true)
  expires_at   DateTime?
  last_used    DateTime?
  last_used_ip String?   @db.VarChar(45)
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@index([tenant_id, is_active]) // Active API keys per tenant
  @@map("api_keys")
}

// ============================================
// FEATURE FLAGS & QUOTAS
// ============================================
model FeatureQuota {
  id         String   @id @default(cuid())
  tenant_id  String   @unique
  max_siswa  Int      @default(100)
  max_guru   Int      @default(20)
  max_kelas  Int      @default(10)
  sms_quota  Int      @default(1000) // Quota SMS/WhatsApp per bulan
  api_calls  Int      @default(10000) // API calls per bulan
  storage_gb Decimal  @default(1) @db.Decimal(10, 2) // Storage dalam GB
  features   Json? // Feature flags (JSON object)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@map("feature_quotas")
}

// ============================================
// INVITE & ROLE PERMISSION
// ============================================
model Invite {
  id          String    @id @default(cuid())
  tenant_id   String
  email       String    @db.VarChar(100)
  role        String    @db.VarChar(20) // 'admin', 'guru'
  token       String    @unique @db.VarChar(255)
  expires_at  DateTime
  accepted_at DateTime?
  invited_by  String // User ID yang mengirim invite
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  // Relations
  tenant  Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  inviter User   @relation(fields: [invited_by], references: [id], onDelete: Restrict)

  @@unique([tenant_id, email])
  @@index([tenant_id, expires_at]) // Active invites per tenant
  @@map("invites")
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique @db.VarChar(100) // Contoh: 'siswa.create', 'presensi.read'
  description String?  @db.Text
  resource    String   @db.VarChar(50) // 'siswa', 'presensi', 'kelas', dll
  action      String   @db.VarChar(50) // 'create', 'read', 'update', 'delete'
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([resource, action]) // Lookup permission by resource+action
  @@map("permissions")
}

// ============================================
// GLOBAL SETTINGS (Super Admin managed)
// ============================================
model GlobalSetting {
  id          String   @id @default(cuid())
  key         String   @unique @db.VarChar(100)
  value       String?  @db.Text
  category    String?  @db.VarChar(50) // 'whatsapp', 'general', 'system'
  updated_at  DateTime @updatedAt
  updated_by  String?

  @@index([category])
  @@map("global_settings")
}

// ============================================
// PRICING PLANS (Global - Super Admin managed)
// ============================================
model PricingPlan {
  id              String   @id @default(cuid())
  key             String   @unique @db.VarChar(50) // 'starter', 'pro', 'enterprise'
  name            String   @db.VarChar(100)
  description     String?  @db.Text
  price_per_siswa Decimal  @db.Decimal(10, 2)
  original_price  Decimal? @db.Decimal(10, 2) // harga coret (promo)
  min_siswa       Int      @default(1)
  max_siswa       Int      @default(100)
  max_guru        Int      @default(20)
  max_kelas       Int      @default(10)
  sms_quota       Int      @default(1000)
  api_calls       Int      @default(10000)
  storage_gb      Decimal  @default(1) @db.Decimal(10, 2)
  features        Json?    // array of feature strings
  is_popular      Boolean  @default(false)
  is_active       Boolean  @default(true)
  sort_order      Int      @default(0)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@index([is_active, sort_order])
  @@map("pricing_plans")
}

// ============================================
// SMTP CONFIGURATION (Global - Super Admin)
// ============================================
model SmtpConfig {
  id          String   @id @default(cuid())
  name        String   @db.VarChar(100) // e.g. 'Primary SMTP', 'Backup SMTP'
  host        String   @db.VarChar(255)
  port        Int      @default(587)
  username    String   @db.VarChar(255)
  password    String   @db.VarChar(255) // encrypted
  from_email  String   @db.VarChar(255)
  from_name   String   @default("Kehadiran") @db.VarChar(100)
  encryption  String   @default("tls") @db.VarChar(10) // 'tls', 'ssl', 'none'
  is_active   Boolean  @default(true)
  is_default  Boolean  @default(false)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("smtp_configs")
}

// ============================================
// EMAIL TEMPLATE (Global - Super Admin)
// ============================================
model EmailTemplate {
  id          String   @id @default(cuid())
  key         String   @unique @db.VarChar(50) // 'registration', 'reset_password', etc.
  name        String   @db.VarChar(100)
  description String?  @db.Text
  subject     String   @db.VarChar(500)
  body_html   String   @db.Text
  variables   Json?    // Available variables e.g. ["nama", "link", "sekolah"]
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("email_templates")
}

// ============================================
// EMAIL LOG (Track all sent emails)
// ============================================
model EmailLog {
  id          String    @id @default(cuid())
  tenant_id   String?
  to_email    String    @db.VarChar(255)
  subject     String    @db.VarChar(500)
  template    String    @db.VarChar(100) // 'registration', 'reset_password', 'payment_success', 'invoice'
  status      String    @default("pending") @db.VarChar(20) // 'pending', 'sent', 'failed'
  error       String?   @db.Text
  sent_at     DateTime?
  created_at  DateTime  @default(now())

  @@index([status, created_at])
  @@index([template, created_at])
  @@index([tenant_id, created_at])
  @@map("email_logs")
}
